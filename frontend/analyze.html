<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Analisis SVM - Final Version</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '#6D28D9',
                            secondary: '#8B5CF6',
                            bg: '#F8FAFC'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { background-color: #F8FAFC; color: #1E293B; }
        
        .card { 
            background: white; 
            border: 1px solid #E2E8F0; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); 
            border-radius: 1rem; 
            overflow: hidden; 
        }

        /* Tombol Interaktif */
        .btn-analyze {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(109, 40, 217, 0.3);
        }
        .btn-analyze:active {
            transform: translateY(0);
        }
        /* Efek Shine */
        .btn-analyze::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
            display: block;
        }
        .btn-analyze:hover::after {
            left: 100%;
            top: 100%;
        }

        /* Loader inside button */
        .loader-dots div {
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .loader-dots div:nth-child(1) { left: 8px; animation: loader-dots1 0.6s infinite; }
        .loader-dots div:nth-child(2) { left: 8px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(3) { left: 32px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(4) { left: 56px; animation: loader-dots3 0.6s infinite; }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes loader-dots3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
        @keyframes loader-dots2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }

        /* Table Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #6D28D9; border-radius: 10px; }
    </style>
</head>

<body class="font-sans min-h-screen">

<header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
        <a href="index.html" class="text-slate-500 hover:text-brand-primary text-xs sm:text-sm font-medium transition-colors">‚Üê Kembali</a>
        <h1 class="font-bold text-lg sm:text-xl text-slate-800">SVM <span class="text-brand-primary">Analytics</span></h1>
        <div class="w-10 sm:w-20"></div>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6 md:space-y-8">
    
    <!-- TAB NAVIGATION -->
    <div class="flex justify-center mb-4 sm:mb-6">
        <div class="bg-slate-200/50 p-1 rounded-full flex gap-1 w-full max-w-sm sm:max-w-md">
            <button id="tabTextBtn" onclick="switchTab('text')" class="flex-1 px-4 py-2 rounded-full bg-brand-primary text-white text-sm sm:text-base font-semibold shadow-md transition-all">üí¨ Teks</button>
            <button id="tabFileBtn" onclick="switchTab('file')" class="flex-1 px-4 py-2 rounded-full text-slate-600 text-sm sm:text-base font-semibold transition-all">üìä Batch</button>
        </div>
    </div>

    <!-- SINGLE TEXT SECTION -->
    <section id="sectionText" class="space-y-6">
        <div class="card p-5 sm:p-8">
            <h2 class="text-base sm:text-lg font-bold mb-4 flex items-center gap-2">‚úçÔ∏è <span>Input Komentar</span></h2>
            <textarea id="inputText" rows="4"
                class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 focus:ring-2 focus:ring-brand-primary focus:border-transparent outline-none transition text-sm sm:text-base"
                placeholder="Masukkan komentar di sini..."></textarea>

                <div class="flex flex-col sm:flex-row gap-3 mt-4">
                    <!-- ANALYZE BUTTON -->
                    <button id="btnAnalyzeText"
                        onclick="analyzeText()"
                        class="btn-analyze flex-1 bg-brand-primary text-white py-3.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 overflow-hidden">
                        <span id="btnText">Analisis Sekarang</span>
                        <div id="btnLoader" class="hidden loader-dots relative w-20 h-4">
                            <div class="absolute top-0 w-3 h-3 rounded-full bg-white"></div>
                            <div class="absolute top-0 w-3 h-3 rounded-full bg-white"></div>
                            <div class="absolute top-0 w-3 h-3 rounded-full bg-white"></div>
                            <div class="absolute top-0 w-3 h-3 rounded-full bg-white"></div>
                        </div>
                    </button>

                    <!-- RESET BUTTON -->
                    <button onclick="resetTextForm()"
                        title="Reset"
                        class="sm:w-14 h-12 sm:h-auto flex items-center justify-center rounded-xl border border-slate-300 text-slate-400 hover:bg-slate-100 hover:text-rose-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
        </div>

        <div id="textResultContainer" class="hidden card p-5 sm:p-8 border-t-4 border-brand-primary animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-50 p-4 rounded-xl text-center border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Sentimen</p>
                    <p id="resSentiment" class="text-xl sm:text-2xl font-black">-</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl text-center border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Kategori</p>
                    <p id="resTopic" class="text-xl sm:text-2xl font-black text-blue-600">-</p>
                </div>
            </div>
            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">Hasil Preprocessing:</p>
            <p id="resPreprocessed" class="font-mono text-xs sm:text-sm text-emerald-700 bg-emerald-50 p-4 rounded-lg border border-emerald-100 break-words">-</p>
        </div>
    </section>

    <!-- BATCH FILE SECTION -->
    <section id="sectionFile" class="hidden space-y-8">
        <!-- Upload -->
        <div id="uploadBox" class="card p-8 sm:p-12 text-center border-2 border-dashed border-slate-300 bg-slate-50/50">
            <div class="w-16 h-16 bg-brand-primary/10 text-brand-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
            </div>
            <h2 class="text-lg sm:text-xl font-bold mb-2">Upload Data Batch</h2>
            <p class="text-slate-500 text-sm mb-6">Format yang didukung: .csv atau .xlsx</p>
            
            <input type="file" id="csvInput" accept=".csv,.xlsx" hidden onchange="fileSelected()">
            <button onclick="document.getElementById('csvInput').click()" class="bg-white border-2 border-brand-primary text-brand-primary px-8 py-3 rounded-xl font-bold hover:bg-brand-primary hover:text-white transition-all shadow-sm mb-4">Pilih File</button>
            
            <p id="fileName" class="text-sm text-brand-primary font-bold hidden mb-4 bg-brand-primary/5 py-2 px-4 rounded-full inline-block"></p>
            
            <button id="btnProcess" onclick="processCsv()" class="btn-analyze hidden w-full bg-emerald-500 text-white py-4 rounded-xl font-bold shadow-lg transition-all">Mulai Analisis File</button>
        </div>

        <!-- DASHBOARD (VERTICAL ORDER) -->
        <div id="dashboardState" class="hidden space-y-8">
            
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold">Hasil Analisis Batch</h2>
                <button onclick="resetBatch()" class="text-xs font-bold text-slate-500 hover:text-brand-primary uppercase tracking-widest flex items-center gap-2">
                    üîÑ Ganti File
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 1. Distribusi Label Kategori -->
                <div class="card p-6">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-brand-primary rounded-full"></span> Distribusi Kategori
                    </h3>
                    <div class="max-w-[250px] mx-auto">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>

                <!-- 2. Sentimen per Label Kategori -->
                <div class="card p-6">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-emerald-500 rounded-full"></span> Sentimen per Kategori
                    </h3>
                    <div class="h-64 sm:h-80">
                        <canvas id="sentimentStackChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 3. Tabel Data -->
            <div class="card">
                <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h3 class="font-bold text-slate-800">Rincian Hasil</h3>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="downloadCSV()" class="flex-1 sm:flex-none text-[10px] bg-brand-primary/10 text-brand-primary px-3 py-2 rounded-lg font-bold hover:bg-brand-primary hover:text-white transition-all">CSV</button>
                        <button onclick="downloadExcel()" class="flex-1 sm:flex-none text-[10px] bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg font-bold hover:bg-emerald-500 hover:text-white transition-all">EXCEL</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-96 custom-scroll">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-slate-400 uppercase">No</th>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-slate-400 uppercase">Komentar</th>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-slate-400 uppercase">Kategori</th>
                                <th class="px-4 py-3 text-left text-[10px] font-black text-slate-400 uppercase">Sentimen</th>
                            </tr>
                        </thead>
                        <tbody id="resultTable" class="divide-y divide-slate-100 text-xs sm:text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- 4. Keywords -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="font-bold text-brand-primary mb-4 border-b pb-2 text-sm uppercase">Top Kata Kunci (Kategori)</h3>
                    <div id="kwCategory" class="space-y-4 text-xs sm:text-sm"></div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold text-brand-primary mb-4 border-b pb-2 text-sm uppercase">Top Kata Kunci (Sentimen)</h3>
                    <div id="kwSentiment" class="space-y-4 text-xs sm:text-sm"></div>
                </div>
            </div>

            <div class="text-center py-6">
                <button onclick="resetBatch()" class="text-slate-400 font-bold text-xs hover:text-brand-primary transition-colors">KEMBALI KE UPLOAD FILE</button>
            </div>
        </div>
    </section>
</main>

<script>
    const API_URL = "http://127.0.0.1:5000";
    let globalData = [];
    let charts = {};

    function switchTab(tab) {
        const isText = tab === 'text';
        document.getElementById('sectionText').classList.toggle('hidden', !isText);
        document.getElementById('sectionFile').classList.toggle('hidden', isText);
        
        document.getElementById('tabTextBtn').className = isText 
            ? "flex-1 px-4 py-2 rounded-full bg-brand-primary text-white text-sm sm:text-base font-semibold shadow-md transition-all" 
            : "flex-1 px-4 py-2 rounded-full text-slate-600 text-sm sm:text-base font-semibold transition-all";
        
        document.getElementById('tabFileBtn').className = !isText 
            ? "flex-1 px-4 py-2 rounded-full bg-brand-primary text-white text-sm sm:text-base font-semibold shadow-md transition-all" 
            : "flex-1 px-4 py-2 rounded-full text-slate-600 text-sm sm:text-base font-semibold transition-all";
    }

    async function analyzeText() {
        const textInput = document.getElementById('inputText');
        const btn = document.getElementById('btnAnalyzeText');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const text = textInput.value.trim();

        if (!text) {
            alert("Harap masukkan teks komentar!");
            return;
        }

        // UI State: Loading
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
        btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/predict-text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            const d = await res.json();

            // Sembunyikan loader
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
            btn.disabled = false;
            btnText.innerText = "Analisis Ulang";

            // Tampilkan hasil
            const resultContainer = document.getElementById('textResultContainer');
            resultContainer.classList.remove('hidden');
            
            document.getElementById('resSentiment').innerText = d.sentimen;
            document.getElementById('resTopic').innerText = d.kategori;
            document.getElementById('resPreprocessed').innerText = d.preprocessed || "-";

            const resSentElem = document.getElementById('resSentiment');
            resSentElem.className = "text-xl sm:text-2xl font-black"; // reset class

            if (d.sentimen.toLowerCase() === 'negatif') {
                resSentElem.classList.add('text-rose-500');
            } else if (d.sentimen.toLowerCase() === 'positif') {
                resSentElem.classList.add('text-emerald-500');
            } else {
                resSentElem.classList.add('text-slate-800');
            }

            // Scroll ke hasil di mobile
            if(window.innerWidth < 640) {
                resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

        } catch (e) {
            alert("Gagal koneksi ke server. Pastikan Backend Flask berjalan.");
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
            btn.disabled = false;
            btnText.innerText = "Analisis Sekarang";
        }
    }

    function resetTextForm() {
        document.getElementById('inputText').value = "";
        document.getElementById('textResultContainer').classList.add('hidden');
        document.getElementById('btnText').innerText = "Analisis Sekarang";
    }

    function fileSelected() {
        const file = document.getElementById('csvInput').files[0];
        if(file) {
            document.getElementById('fileName').innerText = "üìÑ " + file.name;
            document.getElementById('fileName').classList.remove('hidden');
            document.getElementById('btnProcess').classList.remove('hidden');
        }
    }

    async function processCsv() {
        const fileInput = document.getElementById('csvInput');
        const btn = document.getElementById('btnProcess');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        btn.innerText = "Menganalisis Data...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/predict-csv`, { method: 'POST', body: formData });
            globalData = await res.json();
            
            document.getElementById('uploadBox').classList.add('hidden');
            document.getElementById('dashboardState').classList.remove('hidden');
            renderAll();
        } catch(e) { 
            alert("Error memproses file."); 
        } finally {
            btn.innerText = "Mulai Analisis File";
            btn.disabled = false;
        }
    }

    function resetBatch() {
        document.getElementById('dashboardState').classList.add('hidden');
        document.getElementById('uploadBox').classList.remove('hidden');
        document.getElementById('csvInput').value = "";
        document.getElementById('fileName').classList.add('hidden');
        document.getElementById('btnProcess').classList.add('hidden');
    }

    function renderAll() {
        renderPieChart();
        renderStackChart();
        renderTable();
        renderKeywords();
    }

    function renderPieChart() {
        const counts = countBy(globalData, 'kategori');
        if(charts.pie) charts.pie.destroy();
        charts.pie = new Chart(document.getElementById('categoryPieChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(counts),
                datasets: [{ 
                    data: Object.values(counts), 
                    backgroundColor: ['#6D28D9', '#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#EC4899'] 
                }]
            },
            options: { 
                responsive: true,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } 
            }
        });
    }

    function renderStackChart() {
        const cats = [...new Set(globalData.map(d => d.kategori))];
        const sentLabels = ['Positif', 'Netral', 'Negatif'];
        const colors = ['#10B981', '#F59E0B', '#EF4444'];

        const datasets = sentLabels.map((label, i) => ({
            label: label,
            data: cats.map(c => globalData.filter(d => d.kategori === c && d.sentimen === label).length),
            backgroundColor: colors[i]
        }));

        if(charts.stack) charts.stack.destroy();
        charts.stack = new Chart(document.getElementById('sentimentStackChart'), {
            type: 'bar',
            data: { labels: cats, datasets },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    x: { stacked: true, ticks: { font: { size: 10 } } }, 
                    y: { stacked: true, ticks: { font: { size: 10 } } } 
                },
                plugins: { legend: { labels: { boxWidth: 12, font: { size: 10 } } } }
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('resultTable');
        tbody.innerHTML = globalData.map((d, i) => {
            const komentarText = d.text || d.komentar || d.Komentar || d.comment || "Tidak ada teks";
            return `
            <tr>
                <td class="px-4 py-3 text-slate-400 font-medium">${i+1}</td>
                <td class="px-4 py-3 text-slate-700 max-w-[150px] sm:max-w-xs truncate" title="${komentarText}">${komentarText}</td>
                <td class="px-4 py-3 font-semibold text-brand-primary">${d.kategori}</td>
                <td class="px-4 py-3 font-bold ${d.sentimen === 'Positif' ? 'text-emerald-500' : d.sentimen === 'Negatif' ? 'text-rose-500' : 'text-slate-800'}">${d.sentimen}</td>
            </tr>`;
        }).join('');
    }

    function renderKeywords() {
        const groupK = groupKW('kategori');
        const groupS = groupKW('sentimen');
        const sentimentColor = (s) => {
            const lower = s.toLowerCase();
            if (lower === 'positif') return 'bg-emerald-100 text-emerald-700';
            if (lower === 'negatif') return 'bg-rose-100 text-rose-700';
            return 'bg-slate-200 text-slate-800';
        };

        document.getElementById('kwCategory').innerHTML = Object.entries(groupK).map(([key, words]) => `
            <div>
                <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-[4px] text-[10px] font-black uppercase">${key}</span>
                <p class="mt-1 text-slate-500 italic leading-relaxed">${words.join(', ')}</p>
            </div>
        `).join('');

        document.getElementById('kwSentiment').innerHTML = Object.entries(groupS).map(([key, words]) => `
            <div>
                <span class="${sentimentColor(key)} px-2 py-0.5 rounded-[4px] text-[10px] font-black uppercase">${key}</span>
                <p class="mt-1 text-slate-500 italic leading-relaxed">${words.join(', ')}</p>
            </div>
        `).join('');
    }

    function groupKW(field) {
        const res = {};
        globalData.forEach(d => {
            if(!res[d[field]]) res[d[field]] = {};
            const sourceText = d.preprocessed || d.text || d.komentar || "";
            const words = sourceText.toString().toLowerCase().split(/\s+/);
            words.forEach(w => {
                if(w.length > 3 && isNaN(w)) res[d[field]][w] = (res[d[field]][w] || 0) + 1;
            });
        });
        const final = {};
        for(let key in res) {
            final[key] = Object.entries(res[key]).sort((a,b) => b[1] - a[1]).slice(0, 10).map(x => x[0]);
        }
        return final;
    }

    function countBy(arr, key) {
        return arr.reduce((acc, curr) => {
            acc[curr[key]] = (acc[curr[key]] || 0) + 1;
            return acc;
        }, {});
    }

    function downloadCSV() {
        if (!globalData.length) return;
        const headers = ["No", "Komentar", "Kategori", "Sentimen"];
        const rows = globalData.map((d, i) => [i + 1, `"${(d.text || d.komentar || "").replace(/"/g, '""')}"`, d.kategori, d.sentimen]);
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "hasil_svm.csv");
        document.body.appendChild(link);
        link.click();
    }

    function downloadExcel() {
        if (!globalData.length) return;
        const worksheet = XLSX.utils.json_to_sheet(globalData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Hasil");
        XLSX.writeFile(workbook, "hasil_svm.xlsx");
    }
</script>

</body>
</html>